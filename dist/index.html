<!DOCTYPE html><!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]--><!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]--><!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]--><!--[if gt IE 8]><!--><html class="no-js" lang="en"><!--<![endif]--><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
          
          
          
          
          
          
    <title></title>
  <style>.ss-centering{position:relative;margin-left:auto;margin-right:auto;width:56.25vh;height:100vh}.ss-container{position:absolute;top:0;left:0;width:100%;height:100%}.ss-slide{position:absolute;width:100%;height:100%;top:0;left:0;text-align:center}.ss-down-arrow-container{position:absolute;overflow:hidden;margin:0;padding:0}img.ss-down-arrow{position:absolute;position:relative;top:0;left:0;width:100%}.ss-0-0{top:0;left:0}.ss-0-1{top:100%;left:0}.ss-0-2{top:200%;left:0}.ss-0-3{top:300%;left:0}.ss-0-4{top:400%;left:0}.ss-0-5{top:500%;left:0}.ss-0-6{top:600%;left:0}.ss-0-7{top:700%;left:0}.ss-0-8{top:800%;left:0}.ss-0-9{top:900%;left:0}.ss-0-10{top:1000%;left:0}.ss-0-11{top:1100%;left:0}.ss-0-12{top:1200%;left:0}.ss-0-13{top:1300%;left:0}.ss-0-14{top:1400%;left:0}.ss-0-15{top:1500%;left:0}.ss-0-16{top:1600%;left:0}.ss-0-17{top:1700%;left:0}.ss-0-18{top:1800%;left:0}.ss-0-19{top:1900%;left:0}.ss-0-20{top:2000%;left:0}body{margin:0;padding:0;height:100%;overflow:hidden;background-color:#0B1635}.ldl-ss-page{font-family:Arial,"Microsoft YaHei","微软雅黑",sans-serif}.ldl-ss-text-orange{color:#FF7E00}.slide-0 svg{position:absolute;left:0;right:0;top:0;bottom:0}.slide-0-frame{width:98%;height:98%;margin-top:1%;margin-bottom:1%}.slide-1.slide-1-text{font-size:1.2em;color:#fff;text-align:left;position:absolute;top:70%;left:10%}.slide-1-text-1,.slide-1-text-2 div{margin-bottom:.3em}.slide-1-text-1,.slide-1-text-2{opacity:0}.slide-1-sky{position:absolute;width:90%;left:105%}.slide-1-foot{position:absolute;width:56.4%;top:20%;left:-60%}.slide-2{background-color:#0B1635}.slide-2.slide-2-text div{margin-bottom:.2em}.slide-2.slide-2-text div span{margin:.3em}.slide-2.slide-2-text{opacity:0;font-size:1.2em;color:#fff;text-align:left;position:absolute;top:70%;left:10%}.slide-2-orange{color:#FF7E00}.slide-2 .slide-2-earth{position:absolute;top:10%;left:5%;width:90%}.slide-2 .slide-2-girl{position:absolute;top:12%;left:150%;width:11.4%}.slide-2 .slide-2-superman{position:absolute;top:19%;left:150%;width:15.6%}.slide-3 svg{position:absolute;top:0;left:0;right:0;bottom:0}.slide-4{background-color:#0B1635}.slide-4 svg{position:absolute;top:0;left:0;right:0;bottom:0}</style></head>
  <body>

    <div class="ss-centering">
      <div id="main" class="ss-container">
          <div id="slide-0" class="ldl-ss-page ss-slide ss-0-0 slide-0">
  <img class="slide-0-frame" src="slides/slide-0/frame.png">
  <svg id="slide-0-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 1600">
    <image x="0" y="0" width="900" height="900" xlink:href="slides/slide-0/background.png"></image>
    <image id="slide-0-logo" opacity="1.0" x="279" y="950" width="342" height="90" xlink:href="slides/slide-0/logo.png"></image>
    <g id="slide-0-stars"></g>
    <g id="slide-0-text" transform="translate(-600, 550)">
      <text fill="white" font-size="86px" font-family="ldl-ss" transform="matrix(1, -0.2, 0, 1, 0, 0)">
        年度运动旅程
      </text>
    </g>
  </svg>
</div>

          <div id="slide-1" class="ldl-ss-page ss-slide ss-0-1 slide-1">

  <svg id="slide-1-svg" xmlns="http://www.w3.org/2000/svg" viewBox="-450 0 900 1600">

    <g id="slide-1-imgs"></g>

    <g>
      <g id="slide-1-text" transform="translate(-400,1050)" font-size="56px" fill="white">

        <text class="ldl-date" x="0" y="-100" font-size="76px" fill="#FF7E00">
          <tspan id="slide-1-year">2000</tspan><tspan>年</tspan><tspan id="slide-1-month">01</tspan><tspan>月</tspan><tspan id="slide-1-day">01</tspan><tspan>日</tspan>
        </text>

        <g id="slide-1-text-0" opacity="0.0">
          <!-- <text class="ldl-date" x="0" y="-100" font-size="76px" fill="#FF7E00">Date</text> -->
          <text x="0" y="0">我开始使用乐动力</text>
          <text x="0" y="100">走出了历史性的第一步！</text>
        </g>
        <g id="slide-1-text-1" opacity="0.0">
          <!-- <text class="ldl-date" x="0" y="-100" font-size="76px" fill="#FF7E00">Date</text> -->
          <text x="0" y="0">第一次走到<tspan fill="#FF7E00"> 10 </tspan>万步</text>
          <text x="0" y="100">相当于绕香港岛一圈</text>
        </g>
        <g id="slide-1-text-2" opacity="0.0">
          <!-- <text class="ldl-date" x="0" y="-100" font-size="76px" fill="#FF7E00">Date</text> -->
          <text x="0" y="0">第一次走到<tspan fill="#FF7E00"> 100 </tspan>万步</text>
          <text x="0" y="100">相当于奥特曼追到小怪兽的距离</text>
        </g>
      </g>
    </g>

  </svg>
</div>

          <div id="slide-2" class="ldl-ss-page ss-slide ss-0-2 slide-2">
  <svg viewBox="0 0 900 1600">

    <g id="slide-2-images"></g>

    <g id="slide-2-text" font-size="54px" fill="white" transform="translate(50, 900)" opacity="0.0">
      <text x="0" y="0" font-size="78px" fill="#FF7E00" id="slide-2-firstday"></text>
      <text x="0" y="100">第一次使用乐动力跑步功能</text>
      <text x="0" y="200">飞奔了<tspan font-size="76px" fill="#FF7E00" id="slide-2-firstday-running"></tspan>m
      </text>
    </g>

  </svg>
</div>

          <div id="slide-3" class="ldl-ss-page ss-slide ss-0-3 slide-3">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 1600">
    <image x="0" y="0" width="900" height="900" xlink:href="slides/slide-3/background.png"></image>
    <g id="slide-3-self-photo"></g>
    <g id="slide-3-friend-photos"></g>
    <g id="slide-3-text" transform="translate(50, 950)">
      <g id="slide-3-text-summary" opacity="0.0">
        <text x="0" y="0" fill="white" font-size="50px">
          共与<tspan fill="#FF7E00" id="slide-3-friends-count">N</tspan>个好友产生纯洁的运动友谊
        </text>
        <text x="0" y="100" fill="white" font-size="50px">
          我的运动量在我的好友排行中第<tspan fill="#FF7E00" id="slide-3-friends-rank">m</tspan>名
        </text>
      </g>
      <g id="slide-3-text-yuepao" opacity="0.0">
        <image x="0" y="150" width="768" height="82" xlink:href="slides/slide-3/yuepao-text.png"></image>
      </g>
    </g>
  </svg>
</div>

          <div id="slide-4" class="ss-slide ss-0-4 slide-4">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 1600">
    <g id="slide-4-text-pct" transform="translate(450, 420)">
      <text x="0" y="0" font-size="36px" font-family="Arial" text-anchor="middle" fill="white" id="slide-4-complete-rate">00%</text>
    </g>
    <g>
      <polygon transform="translate(450, 410) scale(80)" fill="none" stroke="white" stroke-width="0.10" stroke-linecap="round" points="1.0,0.0 0.5,0.866025403784 -0.5,0.866025403784 -1.0,1.22464679915e-16 -0.5,-0.866025403784 0.5,-0.866025403784"></polygon>
    </g>

    <g id="slide-4-bg-arcs"></g>
    <g id="slide-4-fg-arcs"></g>

    <g id="slide-4-text-summary" opacity="0.0" transform="translate(50, 950)">
      <text x="0" y="0" fill="white" font-size="56px">有<tspan font-size="78px" fill="#FF7E00" id="slide-4-complete-days"> N </tspan>天完成目标，</text>
      <text x="0" y="160" fill="#FF7E00" font-family="ldl-ss" font-size="70px">离人生巅峰还有一定距离！</text>
    </g>
  </svg>
</div>

          <div id="slide-5" class="ldl-ss-page ss-slide ss-0-5 slide-5">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 1600">
    <g>
      <defs>
        <clippath id="slide-5-bright-map-clip">
          <rect x="0" y="0" width="100" height="900"></rect>
        </clippath>
      </defs>
      <image x="0" y="0" width="900" height="900" xlink:href="slides/slide-5/dark-map.png"></image>
      <image x="0" y="0" width="900" height="900" xlink:href="slides/slide-5/bright-map.png" clip-path="url(#slide-5-bright-map-clip)"></image>
    </g>

    <g id="slide-5-rank-circle" transform="translate(700,600) scale(0.0)">
      <g transform="translate(-156, -156)">
        <image x="0" y="0" width="312" height="312" xlink:href="slides/slide-5/circle.png"></image>
        <text x="110" y="120" font-size="48" fill="white">超过</text>
        <text x="80" y="220" font-size="80" fill="white" id="slide-5-better-than-pct">  %</text>
      </g>
    </g>

    <g>
      <text x="50" y="112" opacity="1.0" fill="white" font-size="56">
        我一共走了 <tspan fill="#FF7E00" font-size="78px">
          <tspan id="slide-5-total-steps">0</tspan>
          <tspan> 步</tspan></tspan>
      </text>
      <text x="50" y="208" opacity="1.0" fill="white" font-size="56">
        日均 <tspan fill="#FF7E00" font-size="78px">
          <tspan id="slide-5-avg-steps">0</tspan>
          <tspan> 步</tspan></tspan>
      </text>
    </g>

    <g opacity="1.0" transform="translate(450 1000)">
      <text x="-400" y="-120" fill="#3250a3" font-size="54px">
        可以当之无愧的称自己为
      </text>

      <polyline fill="none" stroke="#FF7E00" stroke-width="10" points="170,-90 250,-90 250,-50"></polyline>
      <polyline fill="none" stroke="#FF7E00" stroke-width="10" points="-170,45 -250,45 -250,5"></polyline>

      <text x="0" y="0" fill="#FF7E00" font-size="80px" text-anchor="middle" transform="scale(0.0)" id="slide-5-call-me">
        运动绝缘体
      </text>
    </g>

    <g opacity="1.0">
      <g id="slide-5-share-btn" transform="translate(450, 1125)">
        <rect fill="#FF7E00" x="-225" y="-45" width="450" height="90" rx="20" ry="20"></rect>
        <text x="0" y="25" font-size="50px" fill="white" text-anchor="middle">去分享</text>
        <text x="0" y="100" font-size="42px" fill="#FF7E00" text-anchor="middle">2015年，乐动力继续陪伴你</text>
      </g>
    </g>

  </svg>
</div>

      </div>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0/handlebars.min.js"></script>
    <script src="//zeptojs.com/zepto.min.js"></script>
    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="//cdn.jsdelivr.net/velocity/1.1.0/velocity.min.js"></script>

    
    
    

    
    

        
        
        
        
        
        

    
  

<script>// http://stackoverflow.com/questions/5623838/rgb-to-hex-and-hex-to-rgb
// function componentToHex(c) {
//   var hex = c.toString(16);
//   return hex.length == 1 ? "0" + hex : hex;
// }

// function rgbToHex(r, g, b) {
//   return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
// }

function rgb2hex(rgb){
 // rgb = rgb.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i);
 return (rgb && rgb.length === 4) ? "#" +
  ("0" + parseInt(rgb[1],10).toString(16)).slice(-2) +
  ("0" + parseInt(rgb[2],10).toString(16)).slice(-2) +
  ("0" + parseInt(rgb[3],10).toString(16)).slice(-2) : '';
}

function rgbToHex(r, g, b) {
  return rgb2hex([null, r, g, b]);
}

// http://stackoverflow.com/questions/3437786/get-the-size-of-the-screen-current-web-page-and-browser-window
function getWindowSize() {
  var w = window,
      d = document,
      e = d.documentElement,
      g = d.getElementsByTagName('body')[0],
      x = w.innerWidth || e.clientWidth || g.clientWidth,
      y = w.innerHeight|| e.clientHeight|| g.clientHeight;
  return [x, y];
}

// http://paulirish.com/2011/requestanimationframe-for-smart-animating/
// http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating

// requestAnimationFrame polyfill by Erik Möller. fixes from Paul Irish and Tino Zijdel

// MIT license

(function() {
  var lastTime = 0;
  var vendors = ['ms', 'moz', 'webkit', 'o'];
  for(var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
    window.requestAnimationFrame = window[vendors[x]+'RequestAnimationFrame'];
    window.cancelAnimationFrame = window[vendors[x]+'CancelAnimationFrame']
      || window[vendors[x]+'CancelRequestAnimationFrame'];
  }

  if (!window.requestAnimationFrame)
    window.requestAnimationFrame = function(callback, element) {
      var currTime = new Date().getTime();
      var timeToCall = Math.max(0, 16 - (currTime - lastTime));
      var id = window.setTimeout(function() { callback(currTime + timeToCall); },
                                 timeToCall);
      lastTime = currTime + timeToCall;
      return id;
    };

  if (!window.cancelAnimationFrame)
    window.cancelAnimationFrame = function(id) {
      clearTimeout(id);
    };
}());

// http://james.padolsey.com/javascript/parsing-urls-with-the-dom/
function parseURL(url) {
  var a =  document.createElement('a');
  a.href = url || (location &&location.href);
  return {
    source: url,
    protocol: a.protocol.replace(':',''),
    host: a.hostname,
    port: a.port,
    query: a.search,
    params: (function(){
      var ret = {},
          seg = a.search.replace(/^\?/,'').split('&'),
          len = seg.length, i = 0, s;
      for (;i<len;i++) {
        if (!seg[i]) { continue; }
        s = seg[i].split('=');
        ret[s[0]] = s[1];
      }
      return ret;
    })(),
    file: (a.pathname.match(/\/([^\/?#]+)$/i) || [,''])[1],
    hash: a.hash.replace('#',''),
    path: a.pathname.replace(/^([^\/])/,'/$1'),
    relative: (a.href.match(/tps?:\/\/[^\/]+(.+)/) || [,''])[1],
    segments: a.pathname.replace(/^\//,'').split('/')
  };
}

// https://remysharp.com/2010/07/21/throttling-function-calls
function throttle(fn, threshhold, scope) {
  threshhold || (threshhold = 250);
  var last,
      deferTimer;
  return function () {
    var context = scope || this;

    var now = +new Date,
        args = arguments;
    if (last && now < last + threshhold) {
      // hold on to it
      clearTimeout(deferTimer);
      deferTimer = setTimeout(function () {
        last = now;
        fn.apply(context, args);
      }, threshhold);
    } else {
      last = now;
      fn.apply(context, args);
    }
  };
}

// http://stackoverflow.com/questions/105034/create-guid-uuid-in-javascript
function uuid() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
    return v.toString(16);
  });
}

/*! sprintf-js | Alexandru Marasteanu <hello@alexei.ro> (http://alexei.ro/) | BSD-3-Clause */

!function(a){function b(){var a=arguments[0],c=b.cache;return c[a]&&c.hasOwnProperty(a)||(c[a]=b.parse(a)),b.format.call(null,c[a],arguments)}function c(a){return Object.prototype.toString.call(a).slice(8,-1).toLowerCase()}function d(a,b){return Array(b+1).join(a)}var e={not_string:/[^s]/,number:/[dief]/,text:/^[^\x25]+/,modulo:/^\x25{2}/,placeholder:/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fiosuxX])/,key:/^([a-z_][a-z_\d]*)/i,key_access:/^\.([a-z_][a-z_\d]*)/i,index_access:/^\[(\d+)\]/,sign:/^[\+\-]/};b.format=function(a,f){var g,h,i,j,k,l,m,n=1,o=a.length,p="",q=[],r=!0,s="";for(h=0;o>h;h++)if(p=c(a[h]),"string"===p)q[q.length]=a[h];else if("array"===p){if(j=a[h],j[2])for(g=f[n],i=0;i<j[2].length;i++){if(!g.hasOwnProperty(j[2][i]))throw new Error(b("[sprintf] property '%s' does not exist",j[2][i]));g=g[j[2][i]]}else g=j[1]?f[j[1]]:f[n++];if("function"==c(g)&&(g=g()),e.not_string.test(j[8])&&"number"!=c(g)&&isNaN(g))throw new TypeError(b("[sprintf] expecting number but found %s",c(g)));switch(e.number.test(j[8])&&(r=g>=0),j[8]){case"b":g=g.toString(2);break;case"c":g=String.fromCharCode(g);break;case"d":case"i":g=parseInt(g,10);break;case"e":g=j[7]?g.toExponential(j[7]):g.toExponential();break;case"f":g=j[7]?parseFloat(g).toFixed(j[7]):parseFloat(g);break;case"o":g=g.toString(8);break;case"s":g=(g=String(g))&&j[7]?g.substring(0,j[7]):g;break;case"u":g>>>=0;break;case"x":g=g.toString(16);break;case"X":g=g.toString(16).toUpperCase()}!e.number.test(j[8])||r&&!j[3]?s="":(s=r?"+":"-",g=g.toString().replace(e.sign,"")),l=j[4]?"0"===j[4]?"0":j[4].charAt(1):" ",m=j[6]-(s+g).length,k=j[6]&&m>0?d(l,m):"",q[q.length]=j[5]?s+g+k:"0"===l?s+k+g:k+s+g}return q.join("")},b.cache={},b.parse=function(a){for(var b=a,c=[],d=[],f=0;b;){if(null!==(c=e.text.exec(b)))d[d.length]=c[0];else if(null!==(c=e.modulo.exec(b)))d[d.length]="%";else{if(null===(c=e.placeholder.exec(b)))throw new SyntaxError("[sprintf] unexpected placeholder");if(c[2]){f|=1;var g=[],h=c[2],i=[];if(null===(i=e.key.exec(h)))throw new SyntaxError("[sprintf] failed to parse named argument key");for(g[g.length]=i[1];""!==(h=h.substring(i[0].length));)if(null!==(i=e.key_access.exec(h)))g[g.length]=i[1];else{if(null===(i=e.index_access.exec(h)))throw new SyntaxError("[sprintf] failed to parse named argument key");g[g.length]=i[1]}c[2]=g}else f|=2;if(3===f)throw new Error("[sprintf] mixing positional and named placeholders is not (yet) supported");d[d.length]=c}b=b.substring(c[0].length)}return d};var f=function(a,c,d){return d=(c||[]).slice(0),d.splice(0,0,a),b.apply(null,d)};"undefined"!=typeof exports?(exports.sprintf=b,exports.vsprintf=f):(a.sprintf=b,a.vsprintf=f,"function"==typeof define&&define.amd&&define(function(){return{sprintf:b,vsprintf:f}}))}("undefined"==typeof window?this:window);


(function(global) {
  var baseUrl = '',
      scope = {
        ENDPOINT : 'http://core.api.ledongli.cn:8090',
        DEV_PATH : '/han_nearline.api',
        PROD_PATH : '/han.api',
        CONFIG_GROUP : 'dev',
        USE_MOCK : false,
        MOCK_STATUS : 'OK'
      };

  if (/github/.test(location.href)) {
    baseUrl = 'http://lge88.github.io/ldl-event-slideshow';
  }

  function ajaxGet(url, dataType, params, callback) {
    var $ = window.$;
    $.ajax({
      type: 'GET',
      url: url,
      data: params,
      dataType: dataType,
      success: function(data) {
        callback(null, data);
      },
      error: function(xhr, type) {
        callback({
          message: 'Can not get ' + url + ' :(',
          url: url,
          params: params,
          type: type,
          xhr: xhr
        });
      }
    });
  }

  function parseDate(dStr) {
    var arr = dStr.split('-');
    return {
      year: arr[0],
      month: arr[1],
      day: arr[2]
    };
  }

  // TODO: if need extra parsing...
  function parseLDLAPIResultData(json) {
    // json.ret.day_10w = new Date(json.ret.day_10w);
    // json.ret.better_than_pct = (100 - parseInt(json.ret.rank_pct)) + '%';
    json.ret.completegoalrate = Math.round(100*(json.ret.completegoalday/json.ret.lifetime));
    json.ret.firstday_parsed = parseDate(json.ret.firstday);
    json.ret.dt_10w_parsed = parseDate(json.ret.dt_10w);
    json.ret.dt_100w_parsed = parseDate(json.ret.dt_100w);
    // console.log(json);
    return json;
  }

  var mockSuccessData = {
    "status": "OK",
    "uid": null,
    "ret": {
      "dt_10w": "2013-06-28",
      "firstday_running_steps": 1000,
      "accumulativesteps": 4160136,
      "dt_100w": "2013-06-29",
      "completegoalday": 279,
      "averagesteps": 11243,
      "dailystatsday": 370,
      "firstday": "2013-04-15",
      "completegoalrate": "0%",
      "avatar_url": "http://tp4.sinaimg.cn/1967427891/180/5656156315/0",
      "running_firstday": "0",
      "rank": 181625,
      "friendsinfo": {
        "friendsrank": 5,
        "friendslist": [
          {
            "avatar_url": "http://files.ledongli.cn/avatar/11779431.jpg"
          },
          {
            "avatar_url": "http://qzapp.qlogo.cn/qzapp/100481185/DEB1A64DE4DCBED7282D145868AAAB44/100"
          },
          {
            "avatar_url": "http://tp1.sinaimg.cn/1718274124/180/5703054401/0"
          },
          {
            "avatar_url": "http://qzapp.qlogo.cn/qzapp/100481185/5FAD852F620FFA5059CBEAF3A8E02BCC/100"
          },
          {
            "avatar_url": "http://files.ledongli.cn/avatar/4148131.jpg"
          }
        ],
        "friends_count": 7
      },
      "lifetime": 619,
      "better_than_pct": "99%",
      "gender": "female"
    },
    "errorCode": 0,
    "error": null,
    "path": null
  };


  function getAnnualUserData(uid, callback) {
    var path,
        url,
        params = {},
        cb = function(err, data) {
          if (err) callback(err, data);
          callback(null, parseLDLAPIResultData(data));
        };

    if (!uid || scope.USE_MOCK) {
      cb(null, mockSuccessData);
    } else {
      path = scope.DEV_PATH;
      if (/^prod/i.test(scope.CONFIG_GROUP)) path = scope.PROD_PATH;
      url = scope.ENDPOINT + path;
      params.action = 'getannualdata';
      params.uid = uid;
      ajaxGet(url, 'jsonp', params, function(err, data) {
        if (err || !data || data.stataus !== 'OK') {
          cb(null, mockSuccessData);
        } else {
          cb(null. data);
        }
      });
    }
  }

  scope.getAnnualUserData = getAnnualUserData;
  global.LDLAPI = scope;

})(window);

(function(global) {

  // TODO: remove dependcy on velocity
  var $ = window.$,
      Velocity = window.$.Velocity,
      getWindowSize = window.getWindowSize,
      noop = function() {};

  function animate(el, endState, options) {
    return Velocity(el, endState, options);
  }

  // https://remysharp.com/2010/07/21/throttling-function-calls
  function throttle(fn, threshhold, scope) {
    threshhold || (threshhold = 250);
    var last,
        deferTimer;
    return function () {
      var context = scope || this;

      var now = +new Date,
          args = arguments;
      if (last && now < last + threshhold) {
        // hold on to it
        clearTimeout(deferTimer);
        deferTimer = setTimeout(function () {
          last = now;
          fn.apply(context, args);
        }, threshhold);
      } else {
        last = now;
        fn.apply(context, args);
      }
    };
  }

  function Slide(aOptions) {
    var options = aOptions || {},
        domEl = options.domEl,
        shouldCreate = typeof options.shouldCreate === 'function' ? options.shouldCreate : function() { return true; },
        onCreate = typeof options.onCreate === 'function' ? options.onCreate : noop,
        onEnter = typeof options.onEnter === 'function' ? options.onEnter : noop,
        onExit = typeof options.onExit === 'function' ? options.onExit : noop,
        context = options.context;

    if (!domEl)
      throw new Error('Can not initialize Slide without provide DOM element!');

    this.domEl = typeof domEl === 'string' ? document.getElementById(domEl) : domEl;
    this.context = context;
    this.onEnter = onEnter.bind(this);
    this.onExit = onExit.bind(this);
    this.onCreate = onCreate.bind(this);
    this.shouldCreate = shouldCreate.bind(this);
  }

  function SlideShow(aContainer, aSlides) {
    var scope = this,
        container = aContainer || document.body,
        slides = Array.isArray(aSlides) ? aSlides : [],
        currentSlide = 0,
        lastSlide = slides.length - 1,

        // For dragging controls:
        blockUserInteraction = false,
        _onMouseMove = throttle(onMouseMove, SlideShow.MOVE_EVENTS_INTERVAL_THRESHOLD),
        _onTouchMove = throttle(onTouchMove, SlideShow.MOVE_EVENTS_INTERVAL_THRESHOLD),
        startFingerX = -1,
        startFingerY = -1,
        startContainerTop = 0,
        dy = 0;

    scope.arrowW = 30;

    document.addEventListener('mousedown', onMouseDown);
    document.addEventListener('mouseup', onMouseUp);
    document.addEventListener('mouseout', onMouseOut);

    document.addEventListener('touchstart', onTouchStart);
    document.addEventListener('touchend', onTouchEnd);
    document.addEventListener('touchcancel', onTouchCancel);

    function resetState() {
      startFingerX = -1;
      startFingerY = -1;
      startContainerTop = 0;
      dy = 0;
    }

    function getSlideHeight() {
      return container.clientHeight;
    }

    function setContainerTop(y) {
      container.style.top = y + 'px';
    }

    function getContainerTop() {
      return container.getBoundingClientRect().top;
    }

    function getSlideIndexShouldBe(currentSlideIndex, dy) {
      var h = getSlideHeight(),
          pct = dy/h,
          n,
          ret;

      if (pct >= SlideShow.START_SCROLL_THRESHOLD) n = 1;
      else if (pct <= -SlideShow.START_SCROLL_THRESHOLD) n = -1;
      else n = 0;

      ret = currentSlideIndex - n;
      if (ret >= lastSlide) return lastSlide;
      if (ret <= 0) return 0;
      return ret;
    }

    function getTargetContainerTopForSlide(slideIdx) {
      var h = getSlideHeight();
      return -slideIdx * h;
    }

    function onMouseDown(ev) {
      console.log(ev);
      ev.preventDefault();
      if (blockUserInteraction) return;

      startFingerX = ev.clientX;
      startFingerY = ev.clientY;
      startContainerTop = getContainerTop();
      console.log("startContainerTop = ", startContainerTop);
      container.addEventListener('mousemove', _onMouseMove);
      ev.stopPropagation();
    }

    function onMouseMove(ev) {
      ev.preventDefault();
      if (blockUserInteraction) return;

      dy = ev.clientY - startFingerY;
      setContainerTop(startContainerTop + dy);
      ev.stopPropagation();
    }

    function onMouseOut(ev) {
      ev.preventDefault();
      if (blockUserInteraction) return;

      container.removeEventListener('mousemove', _onMouseMove);
      var prevSlide = currentSlide,
          slideIndexShouldBe = getSlideIndexShouldBe(currentSlide, dy);
      gotoSlide(slideIndexShouldBe);
      resetState();
      ev.stopPropagation();
    }

    function gotoSlide(targetSlide, aOptions) {
      var prevSlide = currentSlide,
          targetTop = getTargetContainerTopForSlide(targetSlide),
          options = aOptions || {},
          shouldAnimate = options.animate === false ? false : true;

      blockUserInteraction = true;
      if (currentSlide === targetSlide) {
        animate(container, {
          top: targetTop
        }, {
          complete: function() {
            blockUserInteraction = false;
          }
        });
        return;
      }

      currentSlide = targetSlide;

      if (shouldAnimate) {
        animate(container, {
          top: targetTop
        }, {
          complete: function() {
            exitSlide(prevSlide);
            enterSlide(currentSlide);
            blockUserInteraction = false;
          }
        });
      } else {
        setContainerTop(targetTop);
        exitSlide(prevSlide);
        enterSlide(currentSlide);
        blockUserInteraction = false;
      }
    }

    function gotoNextSlide() {
      if (currentSlide < lastSlide) {
        gotoSlide(currentSlide + 1);
      }
    }

    function gotoPrevSlide() {
      if (currentSlide > 0) {
        gotoSlide(currentSlide - 1);
      }
    }

    function onMouseUp(ev) {
       if (ev.target.__onclick) {
        ev.target.__onclick(ev);
        return;
      }

      ev.preventDefault();
      if (blockUserInteraction) return;

      container.removeEventListener('mousemove', _onMouseMove);

      var prevSlide = currentSlide,
          slideIndexShouldBe = getSlideIndexShouldBe(currentSlide, dy);
      gotoSlide(slideIndexShouldBe);
      resetState();

      ev.stopPropagation();
    }

    function onTouchStart(ev) {
      // console.log(ev);
      ev.preventDefault();
      if (blockUserInteraction) return;

      startFingerX = ev.touches[0].clientX;
      startFingerY = ev.touches[0].clientY;
      startContainerTop = getContainerTop();
      container.addEventListener('touchmove', _onTouchMove);
      ev.stopPropagation();
    }

    function onTouchMove(ev) {
      ev.preventDefault();
      if (blockUserInteraction) return;

      dy = ev.touches[0].clientY - startFingerY;
      setContainerTop(startContainerTop + dy);
      ev.stopPropagation();
    }

    function onTouchEnd(ev) {
      // FIXME: a hack to work around the handler blocks all click events
      if (ev.target.__onclick) {
        ev.target.__onclick(ev);
        return;
      }

      ev.preventDefault();
      if (blockUserInteraction) return;

      container.removeEventListener('touchmove', _onTouchMove);

      var prevSlide = currentSlide,
          slideIndexShouldBe = getSlideIndexShouldBe(currentSlide, dy);
      gotoSlide(slideIndexShouldBe);
      resetState();
      ev.stopPropagation();
    }

    function onTouchCancel(ev) {
      ev.preventDefault();
      if (blockUserInteraction) return;

      container.removeEventListener('touchmove', _onTouchMove);

      var prevSlide = currentSlide,
          slideIndexShouldBe = getSlideIndexShouldBe(currentSlide, dy);
      gotoSlide(slideIndexShouldBe);
      resetState();

      ev.stopPropagation();
    }

    function enterSlide(idx) {
      var slide = scope.slides[idx];
      if (slide && slide.onEnter) slide.onEnter();
    }

    function exitSlide(idx) {
      var slide = scope.slides[idx];
      if (slide && slide.onExit) slide.onExit();
    }

    function start() {
      enterSlide(currentSlide);
    }

    function unblockUserInteraction() {
      blockUserInteraction = false;
    }

    function getContainerWidth() {
      return container.getBoundingClientRect().width;
    }

    function getContainerHeight() {
      return container.getBoundingClientRect().height;
    }

    var arrowButton = null;

    function hideArrowButton() {
      if (arrowButton) arrowButton.style.display = 'none';
    }

    function showArrowButton() {
      if (!arrowButton) createArrowButton();

      var div = arrowButton,
          w = getContainerWidth(),
          h = getContainerHeight(),
          arrowW = scope.arrowW,
          arrowTop = (h*0.75 + h*currentSlide) + 'px';

      div.style.top = arrowTop;
      div.style.left = (0.5 * w - 0.5 * arrowW) + 'px';

      arrowButton.style.display = '';
    }

    function createArrowButton() {
      var div = document.createElement('div'),
          img = document.createElement('img'),
          w = getContainerWidth(),
          h = getContainerHeight(),
          arrowW = scope.arrowW;

      div.style.width = arrowW + 'px';
      div.style.height = arrowW/72*102 + 'px';
      div.style.display = 'none';
      div.className = 'ss-down-arrow-container';

      img.src = 'lib/ss-arrow.gif';
      img.className = 'ss-down-arrow';
      img.__onclick = gotoNextSlide;

      div.appendChild(img);
      container.appendChild(div);

      arrowButton = div;
    }

    function init() {
      // slides = slides.filter(function(s) {
      //   return s.shouldCreate();
      // });

      // // fix index, posX, posY
      // // fix css class
      // slides.forEach(function(s, i) {
      //   var ctx = s.context,
      //       $el = $(s.domEl),
      //       oldClassName = 'ss-' + ctx.posX + '-' + ctx.posY,
      //       newClassName;

      //   ctx.index = i;
      //   ctx.posY = i;
      //   newClassName = 'ss-' + ctx.posX + '-' + ctx.posY;

      //   $el
      //     .removeClass(oldClassName)
      //     .addClass(newClassName);
      // });

      slides.forEach(function(s) {
        s.ss = scope;
      });

      // slides.forEach(function(slide) {
      //   slide.onCreate();
      // });
    }

    init();

    scope.start = start;
    scope.slides = slides;
    scope.gotoSlide = gotoSlide;
    scope.unblockUserInteraction = unblockUserInteraction;
    scope.showArrowButton = showArrowButton;
    return scope;
  }

  SlideShow.START_SCROLL_THRESHOLD = 0.05;
  SlideShow.MOVE_EVENTS_INTERVAL_THRESHOLD = 20;

  global.Slide = Slide;
  global.SlideShow = SlideShow;

})(window);


var app = {
  $: window.$,
  d3: window.d3,
  uuid: window.uuid,
  compile: function(source) {
    return Handlebars.compile(source);
  },
  slidesByName: {},
  mainEl: document.getElementById('main'),
  addSlide: function(name, aOptions) {
    var options = aOptions || {},
        urlParams,
        context,
        slide;

    // Apply config from slide*.json
    context = this.config && this.config[name] || {};
    if (aOptions && aOptions.context) {
      Object.keys(aOptions.context).forEach(function(k) {
        context[k] = aOptions.context[k];
      });
    }
    options.context = context;
    options.domEl = name;

    // Apply config from url for this slide
    urlParams = parseURL(location.href).params;
    if (parseInt(urlParams.index) === context.index) {
      Object.keys(urlParams).forEach(function(key) {
        var val;
        if (key !== 'index') {
          val = urlParams[key];
          context[key] = val;
        }
      });
    }

    slide = new Slide(options);
    this.slidesByName[name] = slide;

    return slide;
  },
  bootstrap: function() {
    var slidesByName = this.slidesByName,
        slides = Object.keys(slidesByName).map(function(name) {
          return slidesByName[name];
        }),
        urlParams = parseURL(location.href).params,
        scope = this;

    slides.sort(function(a, b) {
      return a.context.index - b.context.index;
    });

    scope.ss = new SlideShow(scope.mainEl, slides);

    // bootstrap first slide, defer others util api calls back
    scope.ss.slides[0].onCreate();

    // add user data to slides context:
    LDLAPI.getAnnualUserData(urlParams.uid, function(err, data) {
      if (err || !data || !data.ret) {
        // TODO: handle the case can not get user data
        data = scope.mockData;
      }

      app.userData = data.ret;

      var ss = scope.ss;

      ss.slides.forEach(function(slide, i) {
        slide.context.userData = data.ret;
      });

      ss.slides = ss.slides.filter(function(s) {
        return s.shouldCreate();
      });

      // fix index, posX, posY
      // fix css class
      ss.slides.forEach(function(s, i) {
        var ctx = s.context,
            $el = app.$(s.domEl),
            oldClassName = 'ss-' + ctx.posX + '-' + ctx.posY,
            newClassName;

        ctx.index = i;
        ctx.posY = i;
        newClassName = 'ss-' + ctx.posX + '-' + ctx.posY;

        $el
          .removeClass(oldClassName)
          .addClass(newClassName);
      });

      ss.slides.forEach(function(slide, i) {
        if (i === 0) return;
        slide.onCreate();
      });

    });

    scope.ss.start();

    if (urlParams.index) {
      setTimeout(function() {
        scope.ss.gotoSlide(parseInt(urlParams.index), { animate: false });
      }, 100);
    }
  }
};

(function() {
  function chain(context, fns, done) {
    var i = 0, count, j, len, completed;
    function next() {
      var fn = fns[i];

      if (typeof fn === 'function') {
        fn(context, function(err) {
          if (err) {
            done(err);
            return;
          }

          ++i;
          next();
        });
      } else if (Array.isArray(fn)) {
        len = fn.length;
        completed = 0;
        j = 0;
        for (j = 0; j < len; ++j) {
          fn[j](context, function(err) {
            if (err) {
              done(err);
              return;
            }
            completed += 1;
            if (completed === len) {
              ++i;
              next();
            }
          });
        }
      } else {
        done(null, context);
      }
    }
    next();
  }

  function fadeInText(el, duration, cb) {
    app.d3
      .select(el)
      .transition()
      .duration(duration)
      .attr('opacity', 1.0)
      .each('end', cb);
  }

  function fadeOutText(el, duration, cb) {
    app.d3
      .select(el)
      .transition()
      .duration(duration)
      .attr('opacity', 0.0)
      .each('end', cb);
  }

  function makeFadeIn(el, duration) {
    return function(ctx, done) {
      fadeInText(el, duration, function() {
        done();
      });
    };
  }

  function makeFadeOut(el, duration) {
    return function(ctx, done) {
      fadeOutText(el, duration, function() {
        done();
      });
    };
  }

  function makeDelay(delay) {
    return function(ctx, done) {
      setTimeout(function() {
        done();
      }, delay);
    };
  }

  function parseImageUrl(url) {
    var paths = url.split('/'),
        basename = paths[paths.length-1],
        splits = basename.split('.'),
        wh;

    if (splits) {
      wh = splits[0].split('-');
      return {
        width: parseInt(wh[wh.length-2]),
        height: parseInt(wh[wh.length-1]),
        name: wh.slice(0, -2).join('-'),
        ext: splits[1]
      };
    } else return {};
  }

  function initImageElement(el, url, aIdPrefix) {
    var obj = parseImageUrl(url),
        w = obj.width,
        h = obj.height,
        idPrefix = aIdPrefix || '',
        sel = app.d3.select(el);

    sel
      .attr('xlink:href', url)
      .attr('id',  idPrefix + obj.name)
      .attr('width',  w)
      .attr('height',  h)
      .attr('x', 0)
      .attr('y',  0)
      .attr('transform',  'translate(' + [-w/2, -h/2] + ')');
  }

  app.initImageElement = initImageElement;
  app.chain = chain;
  app.fadeInText = fadeInText;
  app.fadeOutText = fadeOutText;
  app.makeFadeIn = makeFadeIn;
  app.makeFadeOut = makeFadeOut;
  app.makeDelay = makeDelay;

})();


      app.config = {"slide-0":{"name":"slide-0","title":"slide-0","index":0,"posX":0,"posY":0,"starAnimationDuration":200,"logoAnimationDuration":200,"textAnimationDuration":0,"textOnBoard":"年度运动旅程","basePath":"slides/slide-0"},"slide-1":{"name":"slide-1","title":"slide-1","index":1,"posX":0,"posY":1,"subslideDelay":500,"subslideDuration":500,"basePath":"slides/slide-1"},"slide-2":{"name":"slide-2","title":"slide-2","index":2,"posX":0,"posY":2,"textAnimationDuration":1000,"runnerAnimationDuration":1000,"supermanStartX":810,"supermanStartY":400,"girlStartX":620,"girlStartY":320,"supermanEndX":670,"supermanEndY":270,"girlEndX":470,"girlEndY":140,"startTheta":170,"endGirlTheta":-90,"endSupermanTheta":-50,"basePath":"slides/slide-2"},"slide-3":{"name":"slide-3","title":"slide-3","index":3,"posX":0,"posY":3,"basePath":"slides/slide-3"},"slide-4":{"name":"slide-4","title":"slide-4","index":4,"posX":0,"posY":4,"rateAnimationDuration":1000,"basePath":"slides/slide-4"},"slide-5":{"name":"slide-5","title":"slide-5","index":5,"posX":0,"posY":5,"circleCenterX":700,"circleCenterY":600,"stepsAccumulateAnimationDuration":1000,"rankCircleAnimationDuration":200,"basePath":"slides/slide-5"}};
    
(function(app) {
  var d3 = app.d3,
      starSize = 32,
      starCenters = [
        { x:249, y: 316 },
        { x:285, y: 309 },
        { x:321, y: 302 },
        { x:357, y: 295 }
      ];

  function reset() {
    var size = 10 * starSize,
        stars = this.stars,
        logo = this.logo,
        text = this.text,
        basePath = this.context.basePath;

    stars.transition().duration(0);
    logo.transition().duration(0);
    text.transition().duration(0);

    stars
      .style('display', 'none')
      .attr('x', function(d) { return d.x; })
      .attr('y', function(d) { return d.y; })
      .attr('width', function(d) { return size; })
      .attr('height', function(d) { return size; })
      .attr('xlink:href', basePath + '/star.png')
      .attr('transform', 'translate(' + [-size/2, -size/2] + ')');

    // logo.attr('opacity', 0.0);

    text.attr('transform', 'translate(' + [-600, 550] + ')');
  }

  app.addSlide('slide-0', {
    onCreate: function() {
      var duration = parseInt(this.context.starAnimationDuration) || 500,
          starData = starCenters.map(function(p, i) {
            p.delay = i*duration;
            p.duration = duration;
            return p;
          }),
          size = 10 * starSize;

      this.stars = d3.select('g#slide-0-stars')
        .selectAll("image")
        .data(starData)
        .enter()
        .append("image");

      this.logo = d3.select('#slide-0-logo');

      this.text = d3.select('g#slide-0-text');

      reset.call(this);
    },
    onEnter: function() {
      var size = starSize,
          logoDuration = parseInt(this.context.logoAnimationDuration) || 200,
          textAnimationDuration = parseInt(this.context.textAnimationDuration) || 200,
          starDelay = 0,
          ss = this.ss;

      // this.logo
      //   .transition()
      //   .duration(logoDuration)
      //   .attr('opacity', 1.0);

      this.stars
        .transition()
        .delay(function(d) {
          starDelay += d.duration;
          return d.delay + logoDuration;
        })
        .each(function() {
          d3.select(this)
            .transition()
            .style('display', '')
            .duration(function(d) { return d.duration; })
            .attr('width', size)
            .attr('height', size)
            .attr('transform', 'translate(' + [-size/2, -size/2] + ')');
        });

      this.text
        .transition()
        .delay(logoDuration + starDelay)
        .duration(500)
        .attr('transform', 'translate(' + [190, 550] + ')')
        .each('end', function() {
          ss.showArrowButton();
        });
    },
    onExit: function() {
      reset.call(this);
    }
  });
})(app);

(function(app) {
  var $ = app.$,
      d3 = app.d3,
      chain = app.chain,
      makeFadeIn = app.makeFadeIn,
      makeFadeOut = app.makeFadeOut,
      makeDelay = app.makeDelay,
      config = app.config['slide-1'],
      basePath = app.config['slide-1'].basePath,
      w = 900,
      hfW = w/2,
      h = 1600,
      hfH = h/2,
      bgImageSize = 900,
      hfBgImageSize = bgImageSize/2,
      slideRotateCenter = { x: 0, y: h },
      slideRotateRadius = h - hfBgImageSize,
      slideData = [
        {
          id: 'slide-1-0',
          elements: [
            {
              translate: [0, 0],
              image: createImageElement(basePath + '/sky-900-900.png', 'slide-1-img-')
            },
            {
              id: 'slide-1-0-foot',
              translate: [-700, 0],
              visibility: 'hidden',
              image: createImageElement(basePath + '/foot-564-360.png', 'slide-1-img-')
            },
          ],
          angle: 0,
          delay: config.subslideDelay || 1000,
          duration: config.subslideDuration || 1000
        },
        {
          id: 'slide-1-1',
          elements: [
            {
              translate: [0, 0],
              image: createImageElement(basePath + '/city-900-900.png', 'slide-1-img-')
            },
            {
              translate: [0, 180],
              image: createImageElement(basePath + '/road-1080-30.png', 'slide-1-img-')
            },
            {
              translate: [750, 180],
              id: 'slide-1-car',
              image: createImageElement(basePath + '/car-576-36.png', 'slide-1-img-')
            }
          ],
          angle: 90,
          delay: config.subslideDelay || 1000,
          duration: config.subslideDuration || 1000
        },
        {
          id: 'slide-1-2',
          elements: [
            {
              image: createImageElement(basePath + '/clouds-900-900.png', 'slide-1-img-'),
              translate: [0, 0]
            },
            {
              image: createImageElement(basePath + '/heart-96-216.png', 'slide-1-img-'),
              translate: [60, -150]
            },
            {
              image: createImageElement(basePath + '/monster-258-216.png', 'slide-1-img-'),
              translate: [210, 0]
            },
            {
              image: createImageElement(basePath + '/aotema-216-216.png', 'slide-1-img-'),
              translate: [-80, 0]
            },
          ],
          angle: 180,
          delay: config.subslideDelay || 1000,
          duration: config.subslideDuration || 1000
        }
      ], slideAnimates;

  function parseImageUrl(url) {
    var paths = url.split('/'),
        basename = paths[paths.length-1],
        splits = basename.split('.'),
        wh;

    if (splits) {
      wh = splits[0].split('-');
      return {
        width: parseInt(wh[wh.length-2]),
        height: parseInt(wh[wh.length-1]),
        name: splits[0],
        ext: splits[1]
      };
    } else return {};
  }

  function createImageElement(url, aIdPrefix) {
    var obj = parseImageUrl(url),
        w = obj.width,
        h = obj.height,
        idPrefix = aIdPrefix || '';

    return {
      'xlink:href': url,
      id: idPrefix + obj.name,
      ext: obj.ext,
      width: w,
      height: h,
      x:0,
      y: 0,
      transform: 'translate(' + [-w/2, -h/2] + ')'
    };
  }

  function addVectors(a, b) {
    return { x: a.x + b.x, y: a.y + b.y };
  }

  function slideLocationFromAngle(angleInDegree) {
    var t= angleInDegree/180*Math.PI,
        vec = {
          x: slideRotateRadius * Math.sin(t),
          y: -slideRotateRadius * Math.cos(t)
        };
    return addVectors(slideRotateCenter, vec);
  }


  function createSubSlide() {
    d3
      .select(this)
      .attr('id', function(d) { return d.id; })
      .attr('transform', function(d) {
        var loc = slideLocationFromAngle(d.angle);
        return 'translate(' + [loc.x, loc.y] + ')';
      })

      .selectAll('g')
      .data(function(d) { return d.elements; })
      .enter()
      .append('g')
      .attr('id', function(d) { return d.id; })
      .attr('visibility', function(d) {
        return d['visibility'] ? d['visibility'] : 'visible';
      })
      .attr('transform', function(d) {
        var str = [];
        if (d.translate) str.push('translate(' + d.translate + ')');
        if (d.rotate) str.push('rotate(' + d.rotate + ')');
        if (d.scale) str.push('scale(' + d.scale + ')');
        return str.join(' ');
      })

      .selectAll('image')
      .data(function(d) {
        return [d.image];
      })
      .enter()
      .append('image')
      .attr('x', function(d) { return d['x']; })
      .attr('y', function(d) { return d['y']; })
      .attr('width', function(d) { return d['width']; })
      .attr('height', function(d) { return d['height']; })
      .attr('transform', function(d) { return d['transform']; })
      .attr('xlink:href', function(d) { return d['xlink:href']; });
  }

  function makeResetText() {
    return function(ctx, done) { resetText(); done(); };
  }

  function animateDigits(el, from, to) {
    d3.select(el)
      .transition()
      .duration(2000)
      .tween("text", function(d) {
        var i = d3.interpolate(from, to),
            prec = (d + "").split("."),
            round = (prec.length > 1) ? Math.pow(10, prec[1].length) : 1;

        return function(t) {
          this.textContent = Math.round(i(t) * round) / round;
        };
      });
  }

  function makeAnimateText(el, to, ndigits, duration) {
    return function(ctx, done) {
      d3.select(el)
        .transition()
        .duration(duration)
        .tween("text", function(d) {
          var from = this.textContent,
              i = d3.interpolate(from, to),
              prec = (from + "").split("."),
              round = (prec.length > 1) ? Math.pow(10, prec[1].length) : 1;

          return function(t) {
            this.textContent = pad(Math.round(i(t) * round) / round, ndigits);
          };
        })
        .each('end', function() {
          done();
        });
    };
  }

  function pad(num, size) {
    var s = num + '';
    while (s.length < size) s = '0' + s;
    return s;
  }

  function animateFirstSlide(ctx, done) {
    var year = ctx.userData.firstday_parsed.year,
        month = ctx.userData.firstday_parsed.month,
        day = ctx.userData.firstday_parsed.day;

    chain(ctx, [
      makeResetText(),
      [
        makeAnimateText('#slide-1-year', year, 4, 1000),
        makeAnimateText('#slide-1-month', month, 2, 1000),
        makeAnimateText('#slide-1-day', day, 2, 1000)
      ],
      animateFoot,
      makeFadeIn('#slide-1-text-0',300),
      // makeDelay(1000),
      // makeFadeOut('#slide-1-text-0', 300)
    ], done);
  }

  function animateSecondSlide(ctx, done) {
    var year = ctx.userData.dt_10w_parsed.year,
        month = ctx.userData.dt_10w_parsed.month,
        day = ctx.userData.dt_10w_parsed.day;

    chain(ctx, [
      makeResetText(),
      [
        makeAnimateText('#slide-1-year', year, 4, 1000),
        makeAnimateText('#slide-1-month', month, 2, 1000),
        makeAnimateText('#slide-1-day', day, 2, 1000)
      ],
      animateCar,
      makeFadeIn('#slide-1-text-1', 300),
      // makeDelay(1000),
      // makeFadeOut('#slide-1-text-1', 300)
    ], done);
  }

  function animateThirdSlide(ctx, done) {
    var year = ctx.userData.dt_100w_parsed.year,
        month = ctx.userData.dt_100w_parsed.month,
        day = ctx.userData.dt_100w_parsed.day;

    chain(ctx, [
      makeResetText(),
      [
        makeAnimateText('#slide-1-year', year, 4, 1000),
        makeAnimateText('#slide-1-month', month, 2, 1000),
        makeAnimateText('#slide-1-day', day, 2, 1000)
      ],
      // animateMonsters,
      makeFadeIn('#slide-1-text-2', 500),
      // makeFadeOut('#slide-1-text-2', 1000)
    ], done);
  }

  // TODO:
  function animateMonsters(ctx, done) {
    done();
  }

  function animateCar(ctx, done) {
    d3.select('#slide-1-car')
      .transition()
      .duration(1000)
      .attr('transform', 'translate(-200, 180)')
      .each('end', function() {
        done();
      });
  }

  function animateFoot(ctx, done) {
    d3
      .select('#slide-1-0-foot')
      .attr('visibility', 'visible')
      .transition()
      .duration(200)
      .ease(d3.ease('elastic'))
      .attr('transform', 'translate(-200, 0)')
      .each('end', function() {
        done();
      });
  }

  function resetText() {
    d3
      .selectAll('#slide-1-text g')
      .attr('opacity', 0.0);
  }

  function rotateSlides(angle, done) {
    var count = 3;
    d3.selectAll('#slide-1-bgs > g')
      .transition()
      .duration(function(d) { return d.duration; })
      .attrTween('transform', function(d) {
        var startAngle = d.angle;

        return function(t) {
          var loc;
          d.angle = startAngle + angle*t;
          loc = slideLocationFromAngle(d.angle);
          return 'translate(' + [loc.x, loc.y] + ')';
        };
      })
      .each('end', function() {
        count--;
        if (count === 0) {
          if (typeof done === 'function')
            done();
        }
      });
  }

  app.addSlide('slide-1', {
    onCreate: function() {
      var userData = this.context.userData || {};
      d3.selectAll('g#slide-1-text > g text.ldl-date')
        .data([
          userData.firstday_parsed,
          userData.dt_10w_parsed,
          userData.dt_100w_parsed,
        ])
        .text(function(d) {
          return d.year + '年' + d.month + '月' + d.day + '日';
        });

      d3
        .select('g#slide-1-imgs')
        .append('g')
        .attr('id', 'slide-1-bgs')

        .selectAll('g')
        .data(slideData)
        .enter()
        .append('g')
        .each(createSubSlide);

      this.animationHandles = [];
      return;
    },
    onEnter: function() {
      var doRotateSlides = function(ctx, done) { rotateSlides(ctx.angle, done); },
          ss = this.ss,
          nSteps = this.context.userData.accumulativesteps,
          animations = [
            animateFirstSlide
          ];

      if (nSteps > 100000) {
        animations.push(makeDelay(1000));
        animations.push(makeFadeOut('#slide-1-text-0', 300));
        animations.push(doRotateSlides);
        animations.push(animateSecondSlide);
      }

      if (nSteps > 1000000) {
        animations.push(makeDelay(1000));
        animations.push(makeFadeOut('#slide-1-text-1', 300));
        animations.push(doRotateSlides);
        animations.push(animateThirdSlide);
      }

      chain({
        userData: this.context.userData,
        angle: -90
      }, animations, function(err, ctx) {
        ss.showArrowButton();
      });
      return;
    },
    onExit: function() {
      resetText();
    }
  });
})(app);

(function(app) {
  var $ = app.$,
      d3 = app.d3,
      config = app.config['slide-2'],
      basePath = config.basePath,
      initImageElement = app.initImageElement,
      chain = app.chain,
      makeFadeIn = app.makeFadeIn,
      fadeInText = app.fadeInText,

      earthCenter = [460, 470],
      earthRadius = 300,

      posOnEarth = function(theta) {
        var cx = earthCenter[0], cy = earthCenter[1];
        var r = earthRadius, t = theta/180*Math.PI;
        return [cx + r*Math.cos(t), cy + r*Math.sin(t)];
      },

      imageData = [
        {
          url: basePath + '/earth-900-900.png',
          translate: [450, 450],
          opacity: 0.0,
          scale: 1,
          rotate: 0
        },
        {
          url: basePath + '/girl-114-192.png',
          // translate: [config.girlStartX, config.girlStartY],
          translate: posOnEarth(config.startTheta),
          scale: 0.0,
          rotate: 0
        },
        {
          url: basePath + '/superman-156-150.png',
          translate: posOnEarth(config.startTheta),
          // translate: [1500, config.supermanStartY],
          // translate: [config.supermanStartX, config.supermanStartY],
          scale: 0.0,
          rotate: 0
        },
      ];
  // compile = app.compile,
  // template = compile($('#slide-2-template').html());

  app.addSlide('slide-2', {
    shouldCreate: function() {
      return this.context &&
        this.context.userData &&
        this.context.userData.firstday_running_steps &&
        this.context.userData.firstday_running_steps > 0;
    },
    onCreate: function() {
      var basePath = this.context.basePath,
          userData = this.context.userData;

      d3.select('#slide-2-images')
        .selectAll('g')
        .data(imageData)
        .enter()
        .append('g')
        .attr('transform', function(d) {
          return [
            'translate(' + d.translate + ')',
            'scale(' + d.scale + ')',
            // 'rotate(' + d.rotate + ')',
          ].join(' ');
        })
        .attr('opacity', function(d) {
          if (typeof d.opacity !== 'undefined') { return d.opacity; }
          return 1.0;
        })
        .append('image')
        .each(function(d) {
          initImageElement(this, d.url, 'slide-2-');
        });

      d3.select('#slide-2-firstday')
        .text(userData.firstday);

      d3.select('#slide-2-firstday-running')
        .text(' ' + userData.firstday_running_steps + ' ');
    },

    onEnter: function() {
      var ctx = {},
          ss = this.ss;
      ctx.textEl = this.context.textEl || '#slide-2-text';
      ctx.textAnimationDuration = parseInt(this.context.textAnimationDuration) || 1000;

      chain(ctx, [
        animateEarth,
        animateText,
        animateGirl,
        animateSuperman
      ], function(err) {
        ss.showArrowButton();
      });
      return;
    },
    onExit: function() {

    }
  });

  function animateText(ctx, done) {
    fadeInText(ctx.textEl, ctx.textAnimationDuration, function() {
      done();
    });
  }

  function animateEarth(ctx, done) {
    var duration = ctx.earthAnimationDuration || 500;
    d3.select('#slide-2-earth')
      .each(function() {
        d3.select(this.parentNode)
          .transition()
          .duration(duration)
          .attr('opacity', 1.0)
          .each('end', function() {
            done();
          });
      });
  }

  function animateGirl(ctx, done) {
    var duration = ctx.runnerAnimationDuration || 500;
    d3.select('#slide-2-girl')
      .each(function() {
        d3.select(this.parentNode)
          .transition()
          .duration(duration)
          .ease(d3.ease('elastic', 1.0, 0.80))
          .attrTween('transform', function() {
            var t0 = config.startTheta, t1 = config.endGirlTheta;
            var diff = t1 - t0;

            return function(t) {
              var theta = t0 + t*diff;
              var pos = posOnEarth(theta);
              return [
                'translate(' + pos + ')',
                'scale(' + t + ')'
              ].join(' ');
            };
          })
          .each('end', function() {
            done();
          });
      });
  }

  function animateSuperman(ctx, done) {
    var duration = ctx.runnerAnimationDuration || 500;
    d3.select('#slide-2-superman')
      .each(function() {
        d3.select(this.parentNode)
          .transition()
          .duration(duration)
          .ease(d3.ease('elastic', 1.0, 0.80))
          .attrTween('transform', function() {
            var t0 = config.startTheta, t1 = config.endSupermanTheta;
            var diff = t1 - t0;

            return function(t) {
              var theta = t0 + t*diff;
              var pos = posOnEarth(theta);
              return [
                'translate(' + pos + ')',
                'scale(' + t + ')'
              ].join(' ');
            };
          })
          .each('end', function() {
            done();
          });
      });
  }
})(app);

(function(app) {
  var $ = app.$,
      d3 = app.d3,
      uuid = app.uuid,

      selfPhotoLocation = { x: 464, y: 448 },
      selfPhotoRadius = 147,
      friendsPhotoSpecs = [
        { x: 700, y: 700, circleborderWidth: 6, rayWidth: 6, radius: 120 },
        { x: 250, y: 150, circleborderWidth: 6, rayWidth: 6, radius: 111 },
        { x: 200, y: 720, circleborderWidth: 3, rayWidth: 3, radius: 105 },
        { x: 600, y: 160, circleborderWidth: 3, rayWidth: 3, radius: 90 },
        { x: 100, y: 500, circleborderWidth: 3, rayWidth: 3, radius: 81 }
      ],
      ORANGE = '#FF7E00';
  // compile = app.compile,
  // textTemplate = compile($('#slide-3-template-text').html());

  friendsPhotoSpecs = calculateLinesFromSelfToFriend(friendsPhotoSpecs);

  function calculateLinesFromSelfToFriend(friendsPhotoSpecs) {
    friendsPhotoSpecs.forEach(function(spec) {
      spec.lineX0 = spec.x;
      spec.lineY0 = spec.y;
      spec.lineX1 = selfPhotoLocation.x;
      spec.lineY1 = selfPhotoLocation.y;
    });
    return friendsPhotoSpecs;
  }

  function SelfPhoto(imgUrl) {
    this.uid = uuid();
    this.url = imgUrl;
  }
  // SelfPhoto.template = compile($('#slide-3-template-self-photo').html());
  SelfPhoto.location = { x: 464, y: 448 };
  SelfPhoto.radius = 150;
  SelfPhoto.diameter = 2 * SelfPhoto.radius;

  SelfPhoto.prototype.addToDOM = function(el) {
    var patternId = this.uid,
        r = SelfPhoto.radius,
        d = 2*r,
        url = this.url,
        x = SelfPhoto.location.x,
        y = SelfPhoto.location.y;

    d3.select(el)
      .append('defs')
      .append('pattern').attr('id', patternId).attr('x', -r).attr('y', -r)
      .attr('patternUnits', 'userSpaceOnUse')
      .attr('width', d)
      .attr('height', d)
      .append('image')
      .attr('x', 0).attr('x', 0)
      .attr('width', d).attr('height', d)
      .attr('xlink:href', url);

    d3.select(el)
      .append('circle')
      .attr('transform', 'translate(' + [x, y] + ')')
      .attr('r', r)
      .attr('fill', 'url(#' + patternId + ')');
  };

  SelfPhoto.prototype.compileToHTML = function() {
    var data = {
      patternId: uuid(),
      url: this.url,
      radius: SelfPhoto.radius,
      diameter: SelfPhoto.diameter,
      x: SelfPhoto.location.x,
      y: SelfPhoto.location.y
    };
    return SelfPhoto.template(data);
  };

  function FriendPhoto(imgUrl, location, radius, circleborderWidth, rayWidth) {
    this.id = uuid();
    this.url = imgUrl;
    this.location = location;
    this.radius = radius;
    this.circleborderWidth = circleborderWidth;
    this.rayWidth = rayWidth;
  }
  // FriendPhoto.template = compile($('#slide-3-template-friend-photo').html());

  FriendPhoto.prototype.addToDOM = function(el) {
    var id = this.id,
        patternId = uuid(),
        r = this.radius,
        d = 2*r,
        url = this.url,
        x = this.location.x,
        y = this.location.y;

    d3.select(el)
      .append('defs')
      .append('pattern').attr('id', patternId).attr('x', -r).attr('y', -r)
      .attr('patternUnits', 'userSpaceOnUse')
      .attr('width', d)
      .attr('height', d)
      .append('image')
      .attr('x', 0).attr('x', 0)
      .attr('width', d).attr('height', d)
      .attr('xlink:href', url);

    d3.select(el)
      .append('circle')
      .attr('id', id)
      .attr('transform', 'translate(' + [x, y] + ')')
      .attr('r', 0)
      .attr('fill', 'url(#' + patternId + ')')
      .attr('stroke', ORANGE)
      .attr('stroke-width', this.circleborderWidth);

    var cx = 460, cy = 450, dx = x - cx, dy = y - cy, l = Math.sqrt(dx*dx+dy*dy);
    var cos = dx/l, sin = dy/l;
    var rSelfPhoto = 170;
    var x1 = cx + rSelfPhoto*cos, y1 = cy + rSelfPhoto*sin;
    var x2 = x - r*cos, y2 = y - r*sin;

    d3.select(el)
      .append('line')
      .attr('id', this.id + '-line')
      .attr('stroke-width', this.rayWidth)
      .attr('stroke', ORANGE)
      .attr('visibility', 'hidden')
      .attr('x1', x1)
      .attr('y1', y1)
      .attr('x2', x2)
      .attr('y2', y2);
  };

  FriendPhoto.prototype.compileToHTML = function() {
    var data = {
      id: this.id,
      patternId: uuid(),
      url: this.url,
      radius: this.radius,
      diameter: 2 * this.radius,
      x: this.location.x,
      y: this.location.y
    };
    return FriendPhoto.template(data);
  };

  FriendPhoto.prototype.present = function(duration, delay) {
    var id = this.id, r = this.radius, loc = this.location,
        lineAnimateId,
        animateId = setTimeout(function() {
          $('#' + id)
            .css('display', '')
            .velocity({ translateX: loc.x, translateY: loc.y }, {duration: 0})
            .velocity({ r: r }, {
              duration: duration,
              delay: delay,
              easing: [300, 20],
              complete: function() {
                $('#' + id + '-line').attr('visibility', 'visible');
              }
            });
        }, delay);
    return {
      stop: function() {
        clearTimeout(animateId);
        clearTimeout(lineAnimateId);
        $('#' + id).velocity('stop', true);
        $('#' + id).css('display', 'none');
      }
    };
  };

  app.addSlide('slide-3', {
    onCreate: function() {
      var selfImgUrl = this.context && this.context.userData && this.context.userData.avatar_url,
          selfPhoto = new SelfPhoto(selfImgUrl),
          friendsList = this.context && this.context.userData &&
            this.context.userData.friendsinfo &&
            this.context.userData.friendsinfo.friendslist || [];

      this.photosContainer = $('#slide-3-self-photo', this.domEl)[0];
      selfPhoto.addToDOM(this.photosContainer);

      d3.select('#slide-3-friends-count')
        .text(' ' + this.context.userData.friendsinfo.friends_count + ' ');

      d3.select('#slide-3-friends-rank')
        .text(' ' + this.context.userData.friendsinfo.friendsrank + ' ');

      this.$summary = $('#slide-3-text-summary', this.domEl);
      this.$yuepao = $('#slide-3-text-yuepao', this.domEl);


      this.friendsPhotos = [];
      // this.friendsPhotoContainer = $('#slide-3-friend-photos', this.domEl)[0];
      friendsList = friendsList.slice(0, 5);

      friendsList.forEach(function(p, i) {
        var url = p.avatar_url,
            photo = new FriendPhoto(
              url,
              { x: friendsPhotoSpecs[i].x, y: friendsPhotoSpecs[i].y },
              friendsPhotoSpecs[i].radius,
              friendsPhotoSpecs[i].circleborderWidth,
              friendsPhotoSpecs[i].rayWidth
            );
        // html = photo.compileToHTML();

        photo.addToDOM('#slide-3-friend-photos');

        // this.friendsPhotoContainer.innerHTML += html;
        this.friendsPhotos.push(photo);
      }, this);
    },
    onEnter: function() {
      // TODO: clean up use d3
      var dt = this.context.avatarShowDuration || 200,
          ss = this.ss,
          friendsList = this.context && this.context.userData &&
            this.context.userData.friendsinfo &&
            this.context.userData.friendsinfo.friendslist || [];

      $(this.$summary).velocity({
        opacity: 1.0
      }, {
        duration: 1500
      });

      // this.friendsPhotos = [];
      // this.friendsPhotoContainer = $('#slide-3-friend-photos', this.domEl)[0];
      // friendsList = friendsList.slice(0, 5);

      // friendsList.forEach(function(p, i) {
      //   var url = p.avatar_url,
      //       photo = new FriendPhoto(
      //         url,
      //         { x: friendsPhotoSpecs[i].x, y: friendsPhotoSpecs[i].y },
      //         friendsPhotoSpecs[i].radius
      //       );
      //   // html = photo.compileToHTML();

      //   photo.addToDOM('#slide-3-friend-photos');

      //   // this.friendsPhotoContainer.innerHTML += html;
      //   this.friendsPhotos.push(photo);
      // }, this);

      this.animationHandles = [];

      this.friendsPhotos.forEach(function(p, i) {
        this.animationHandles.push(p.present(dt, dt * i));
      }, this);

      $(this.$yuepao).velocity({
        opacity: 1.0
      }, {
        delay: 1500,
        duration: 800
      });

      // TODO: make duration and delay a parameter
      setTimeout(function() {
        ss.showArrowButton();
      }, 2300);

    },
    onExit: function() {
      // TODO:
    }
  });
})(app);

(function(app) {
  var d3 = app.d3,
      arcCenter = [450, 425],
      startInnerRadius = 206,
      maxRandomAngle = 30,
      w = 15,
      arcData = [
        { startAngle: 60, endAngle: 290, color: '#1d3689', width: w },
        { startAngle: 60, endAngle: 290, color: '#1d3689', width: w },
        { startAngle: 60, endAngle: 290, color: '#1d3689', width: w },
        { startAngle: 60, endAngle: 290, color: '#0177c1', width: w },
        { startAngle: 60, endAngle: 290, color: '#0177c1', width: w },
        { startAngle: 60, endAngle: 290, color: '#0177c1', width: w },
        { startAngle: 60, endAngle: 290, color: '#73d36c', width: w },
        { startAngle: 60, endAngle: 290, color: '#73d36c', width: w },
        { startAngle: 60, endAngle: 290, color: '#73d36c', width: w },
        { startAngle: 60, endAngle: 290, color: '#30b949', width: w },
        { startAngle: 60, endAngle: 290, color: '#30b949', width: w },
        { startAngle: 60, endAngle: 290, color: '#30b949', width: 2*w }
      ],
      bgArc = d3.svg.arc()
        .startAngle(function(d) { return d.startAngle/180*Math.PI; })
        .endAngle(function(d) { return d.endAngle/180*Math.PI; })
        .innerRadius(function(d) { return d.innerRadius; })
        .outerRadius(function(d) { return d.outerRadius; }),
      fgArc = d3.svg.arc()
        .startAngle(function(d) { return d.startAngle/180*Math.PI; })
        .endAngle(function(d) { return d.currentAngle/180*Math.PI;; })
        .innerRadius(function(d) { return d.innerRadius; })
        .outerRadius(function(d) { return d.outerRadius; });

  function setCurrentAngle(arcData) {
    arcData.forEach(function(a) {
      a.currentAngle = a.startAngle;
    });
  }

  function applyRandomAngle(arcData, da) {
    arcData.forEach(function(a) {
      a.startAngle += (Math.random()-1)*2*da;
      a.endAngle += (Math.random()-1)*2*da;
    });
  }

  function computeInnerOuter(arcData) {
    arcData.reduce(function(sofar, a) {
      a.innerRadius = sofar;
      a.outerRadius = sofar + a.width;
      return a.outerRadius;
    }, startInnerRadius);
  }

  function computeFgEndAngle(arcData, r) {
    r = r/100;
    arcData.forEach(function(a) {
      a.fgEndAngle = a.startAngle + r*(a.endAngle - a.startAngle);
    });
  }

  applyRandomAngle(arcData, maxRandomAngle);
  setCurrentAngle(arcData);
  computeInnerOuter(arcData);

  app.addSlide('slide-4', {
    onCreate: function() {
      d3.select('#slide-4-bg-arcs')
        .selectAll('path')
        .data(arcData)
        .enter()
        .append('path')
        .attr('d', bgArc)
        .attr('transform', 'translate(' + arcCenter + ')')
        .attr('fill', function(d) {
          return d3.rgb(d.color).darker(3.0);
        });

      d3.select('#slide-4-fg-arcs')
        .selectAll('path')
        .data(arcData)
        .enter()
        .append('path')
        .attr('d', fgArc)
        .attr('transform', 'translate(' + arcCenter + ')')
        .attr('fill', function(d) {
          return d.color;
        });

      d3.select('#slide-4-complete-days')
        .text(' ' + this.context.userData.completegoalday + ' ');
    },
    onEnter: function() {
      var rate = this.context.userData.completegoalrate,
          rateAnimationDuration = parseInt(this.context.rateAnimationDuration) || 2000,
          ss = this.ss;

      computeFgEndAngle(arcData, rate);

      d3.select('#slide-4-complete-rate')
        .transition()
        .duration(rateAnimationDuration)
        .tween("text", function() {
          var i = d3.interpolateRound(0, rate);
          return function(t) {
            var d = i(t);
            if (d < 10) this.textContent = '0' + i(t) + '%';
            else this.textContent = i(t) + '%';
          };
        });

      d3.select('#slide-4-fg-arcs')
        .selectAll('path')
        .data(arcData)
        .transition()
        .duration(rateAnimationDuration)
        .attrTween('d', function(d) {
          var i = d3.interpolateNumber(d.startAngle, d.fgEndAngle);
          return function(t) {
            d.currentAngle = i(t); return fgArc(d);
          };
        });

      d3.select('#slide-4-text-summary')
        .transition()
        .delay(rateAnimationDuration)
        .duration(rateAnimationDuration)
        .attr('opacity', 1.0);

      setTimeout(function() {
        ss.showArrowButton();
      }, rateAnimationDuration + rateAnimationDuration);

    },
    onExit: function() {

    }
  });
})(app);

(function(app) {
  var compile = app.compile,
      $ = app.$,
      d3 = app.d3;
      // text1Template = compile($('#slide-5-template-text-1').html()),
      // rankCircleTemplate = compile($('#slide-5-template-rank-circle').html());

  function animateTextNumber(el, dest, duration) {
    var startTime = Date.now(),
        startValue = parseInt(el.textContent),
        dist = dest - startValue,
        animate = function () {
          var t = Date.now(),
              progress = (t-startTime)/duration;
          if (progress > 0.99) {
            el.textContent = '' + dest;
            stop();
          } else {
            el.textContent = '' + Math.round(startValue + progress*dist);
            requestAnimationFrame(animate);
          }
        };

    function stop() {
      animate = function() {};
    }

    animate();

    return {
      stop: stop
    };
  }

  function animateRectWidth($rect, destW, duration) {
    $rect.velocity({
      width: destW
    }, {
      duration: duration
    });

    return {
      stop: function() {
        $rect[0].width = 0;
        $rect.velocity('stop');
      }
    };
  }


  function animateRankCircle(el, x, y, destScale, delay, duration) {
    d3.select(el)
      .transition()
      .delay(delay)
      .duration(duration)
      .attr('transform', 'translate(' + [x,y] + ') scale(' + destScale + ')');

    // $el
    //   .velocity({
    //     translateX: x,
    //     translateY: y,
    //     scale: 0.0
    //   }, {
    //     delay: delay,
    //     duration: 0
    //   })
    //   .velocity({
    //     scale: destScale
    //   }, {
    //     duration: duration
    //   });

    return {
      stop: function() {
        // $el.velocity('stop', true);
        // $el[0].scale = 0.0;
        // $el[0].translateX = x;
        // $el[0].translateY = y;
      }
    };
  }

  function callMe(pct, sex) {

    var iPct = parseInt(pct, 10);

    if (/^[fF]/.test(sex)) {
      if (iPct <= 40) {
        return "运动白富美";
      } else if (iPct > 40 && iPct <= 70) {
        return "运动女神";
      } else {
        return "运动界的范爷";
      }
    } else {
      if (iPct <= 40) {
        return "运动高富帅";
      } else if (iPct > 40 && iPct <= 70) {
        return "运动男神";
      } else {
        return "运动钢铁侠";
      }
    }
  }

  app.addSlide('slide-5', {
    onCreate: function() {
      var pct = this.context.userData.better_than_pct,
          sex = this.context.userData.gender || 'male',
          shareUrl = 'http://ledongli.cn/';

      this.totalStepTextEl = $('#slide-5-total-steps')[0];
      this.avgStepTextEl = $('#slide-5-avg-steps')[0];

      this.$clipRect = $('#slide-5-bright-map-clip rect');

      this.$rankCircle = $('#slide-5-rank-circle');

      d3.select('#slide-5-better-than-pct')
        .text(pct);

      d3.select('#slide-5-call-me')
        .text(callMe(pct, sex));

      d3.select('#slide-5-share-btn text')
        .on('click', function() {
          var win = window.open(shareUrl, '_blank');
          win.focus();
        });

      this.animationHandles = [];
    },
    onEnter: function() {
      var stepAccDuration = this.context.stepsAccumulateAnimationDuration || 2000,
          rankCircleDuration = this.context.rankCircleAnimationDuration || 200,
          destWidth = 800,
          totalSteps = this.context.userData.accumulativesteps,
          avgSteps = this.context.userData.averagesteps;

      this.animationHandles.push(animateTextNumber(this.totalStepTextEl, totalSteps, stepAccDuration));
      this.animationHandles.push(animateTextNumber(this.avgStepTextEl, avgSteps, stepAccDuration));
      this.animationHandles.push(animateRectWidth(this.$clipRect, destWidth, stepAccDuration));
      this.animationHandles.push(animateRankCircle(
        this.$rankCircle[0],
        this.context.circleCenterX,
        this.context.circleCenterY,
        1.0,
        stepAccDuration,
        rankCircleDuration));

      d3.select('#slide-5-call-me')
        .transition()
        .duration(500)
        .delay(rankCircleDuration+stepAccDuration)
        .attr('transform', 'scale(1.0)');
    },
    onExit: function() {
      this.animationHandles.forEach(function(handle) {
        handle.stop();
      });
    }
  });
})(app);


      app.bootstrap();
    </script></body></html>